name: Multi-platform build & upload to S3 (versioned filenames)

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  AWS_REGION: "ap-south-1"
  FLUTTER_CHANNEL: "stable"

jobs:
  build-android:
    name: Build Android (arm64) + Upload
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: ${{ env.FLUTTER_CHANNEL }}

      - name: Flutter pub get
        run: flutter pub get

      - name: Build Android arm64 APK (unsigned)
        run: |
          set -euo pipefail
          flutter clean
          flutter build apk --release --target-platform android-arm64 --split-per-abi
          ls -la build/app/outputs/flutter-apk/

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Install awscli (Linux)
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y python3-pip
          python3 -m pip install --upgrade pip awscli
          aws --version

      - name: Parse version and upload APK to S3
        env:
          BUCKET: ${{ secrets.AWS_S3_BUCKET }}
          ENABLE_LATEST_ALIAS: ${{ secrets.ENABLE_LATEST_ALIAS }}
          ENABLE_PRESIGN: ${{ secrets.ENABLE_PRESIGN }}
        run: |
          set -euo pipefail

          APK_SRC="build/app/outputs/flutter-apk/app-arm64-v8a-release.apk"
          if [ ! -f "$APK_SRC" ]; then
            echo "ERROR: APK not found at $APK_SRC"
            ls -la build/app/outputs/flutter-apk || true
            exit 1
          fi

          # Read version from pubspec.yaml (format: version: 1.3.5+42)
          VERSION_LINE=$(grep '^version:' pubspec.yaml | head -n1 || true)
          if [ -z "$VERSION_LINE" ]; then
            echo "ERROR: version not found in pubspec.yaml"
            exit 1
          fi
          VERSION_RAW=$(echo "$VERSION_LINE" | sed 's/^version:[[:space:]]*//')
          VERSION_NAME="${VERSION_RAW%%+*}"
          VERSION_CODE="${VERSION_RAW#*+}"
          if [ "$VERSION_CODE" = "$VERSION_RAW" ]; then VERSION_CODE=""; fi

          SAFE_VERSION="${VERSION_NAME}"
          if [ -n "$VERSION_CODE" ]; then SAFE_VERSION="${SAFE_VERSION}_${VERSION_CODE}"; fi
          # Sanitize
          SAFE_VERSION=$(echo "$SAFE_VERSION" | sed 's/[^A-Za-z0-9._-]/_/g')

          TARGET_FILENAME="app-android-arm64-${SAFE_VERSION}.apk"
          S3_KEY="${TARGET_FILENAME}"
          S3_URI="s3://${BUCKET}/${S3_KEY}"
          PUBLIC_URL="https://${BUCKET}.s3.${AWS_REGION}.amazonaws.com/${S3_KEY}"

          echo "Uploading $APK_SRC -> $S3_URI"
          aws s3 cp "$APK_SRC" "$S3_URI"

          echo "Uploaded: $PUBLIC_URL"

          if [ "${ENABLE_LATEST_ALIAS:-}" = "true" ]; then
            echo "Also updating latest-android.apk alias..."
            aws s3 cp "$APK_SRC" "s3://${BUCKET}/latest-android.apk"
            echo "latest-android.apk updated"
          fi

          if [ "${ENABLE_PRESIGN:-}" = "true" ]; then
            PRESIGNED=$(aws s3 presign "s3://${BUCKET}/${S3_KEY}" --expires-in 3600 || true)
            echo "Presigned URL (1h): ${PRESIGNED}"
          fi

  build-windows:
    name: Build Windows (x64) + Upload
    runs-on: windows-latest
    needs: build-android

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Flutter on Windows
        uses: subosito/flutter-action@v2
        with:
          channel: ${{ env.FLUTTER_CHANNEL }}

      - name: Flutter pub get (Windows)
        run: flutter pub get
        shell: pwsh

      - name: Enable Windows desktop & build (Windows)
        run: |
          flutter config --enable-windows-desktop || true
          flutter clean
          flutter build windows --release
        shell: pwsh

      - name: Configure AWS credentials (Windows)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Install awscli (Windows)
        run: |
          python -m pip install --upgrade pip awscli
          aws --version
        shell: pwsh

      - name: Zip data folder and upload to S3 (Windows)
        env:
          BUCKET: ${{ secrets.AWS_S3_BUCKET }}
          ENABLE_LATEST_ALIAS: ${{ secrets.ENABLE_LATEST_ALIAS }}
          ENABLE_PRESIGN: ${{ secrets.ENABLE_PRESIGN }}
          AWS_REGION: ${{ env.AWS_REGION }}
        shell: pwsh
        run: |
          # PowerShell error handling
          $ErrorActionPreference = 'Stop'
          $ProgressPreference = 'SilentlyContinue'

          Write-Host "Looking for data folder under build/windows..."

          # Prefer exact path first (user requested build/windows/x64/runner/Debug/data)
          $preferred = "build\windows\x64\runner\Debug\data"
          $dataPath = $null

          if (Test-Path $preferred) {
            $dataPath = $preferred
            Write-Host "Found preferred data folder: $dataPath"
          } else {
            # Fallback: find any 'data' folder under build\windows (first match)
            $found = Get-ChildItem -Path "build\windows" -Directory -Recurse -ErrorAction SilentlyContinue |
                     Where-Object { $_.Name -ieq "data" } |
                     Select-Object -First 1
            if ($found) {
              $dataPath = $found.FullName
              Write-Host "Found data folder via search: $dataPath"
            }
          }

          if (-not $dataPath) {
            Write-Error "ERROR: Could not find data folder under build/windows. Checked preferred path and recursive search."
            Get-ChildItem -Path build\windows -Recurse -Force | Select-Object FullName, Attributes | Format-List -Force
            exit 1
          }

          # Read version from pubspec.yaml
          $pubText = Get-Content -Path pubspec.yaml -Raw
          $versionLine = ($pubText -split "`n" | Where-Object { $_ -match '^\s*version\s*:' } | Select-Object -First 1)
          if (-not $versionLine) { Write-Error "ERROR: version not found in pubspec.yaml"; exit 1 }
          $versionRaw = ($versionLine -replace '^\s*version\s*:\s*','').Trim()
          $versionName = ($versionRaw -split '\+')[0]
          $versionCode = ($versionRaw -split '\+') | Select-Object -Last 1
          if ($versionCode -eq $versionName) { $versionCode = "" }

          $safeVersion = $versionName
          if ($versionCode -ne "") { $safeVersion = "${safeVersion}_$versionCode" }
          $safeVersion = ($safeVersion -replace '[^A-Za-z0-9._-]','_')

          # Create zip filename: app-windows-data-<version>.zip
          $zipName = "app-windows-data-$safeVersion.zip"
          $zipPath = Join-Path -Path $env:TEMP -ChildPath $zipName

          Write-Host "Zipping contents of: $dataPath"
          if (Test-Path $zipPath) { Remove-Item -Path $zipPath -Force -ErrorAction SilentlyContinue }

          # Compress-Archive requires files / folders. Use -LiteralPath with wildcard for contents
          Push-Location $dataPath
          try {
            # compress only contents of the folder (not the parent folder)
            # create a list of items in the data folder
            $items = Get-ChildItem -Force -File -Directory | ForEach-Object { $_.FullName }
            if ($items.Count -eq 0) {
              Write-Error "ERROR: data folder exists but is empty: $dataPath"
              exit 1
            }
            Compress-Archive -Path $items -DestinationPath $zipPath -Force
          } finally {
            Pop-Location
          }

          if (-not (Test-Path $zipPath)) {
            Write-Error "ERROR: zip creation failed: $zipPath not found"
            exit 1
          }

          Write-Host "ZIP created at: $zipPath"

          # Upload zip to S3
          $s3Key = $zipName
          $s3Uri = "s3://$($env:BUCKET)/$s3Key"
          Write-Host "Uploading $zipPath -> $s3Uri"
          aws s3 cp --only-show-error $zipPath $s3Uri

          $publicUrl = "https://$($env:BUCKET).s3.$($env:AWS_REGION).amazonaws.com/$s3Key"
          Write-Host "Uploaded: $publicUrl"

          # Optionally update a stable alias
          if ($env:ENABLE_LATEST_ALIAS -eq "true") {
            Write-Host "Updating latest-windows-data.zip alias..."
            aws s3 cp --only-show-error $zipPath "s3://$($env:BUCKET)/latest-windows-data.zip"
            Write-Host "latest-windows-data.zip updated"
          }

          # Optionally output presigned URL (requires s3:GetObject)
          if ($env:ENABLE_PRESIGN -eq "true") {
            $presigned = aws s3 presign "s3://$($env:BUCKET)/$s3Key" --expires-in 3600
            Write-Host "Presigned URL (1h): $presigned"
          }

          # Clean up local zip
          Remove-Item -Path $zipPath -Force -ErrorAction SilentlyContinue

          Write-Host "Done"
