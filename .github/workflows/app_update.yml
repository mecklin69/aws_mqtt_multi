name: Build ARM64 APK & Upload Bundle to S3

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-arm64-apk:
    runs-on: ubuntu-latest

    env:
      FLUTTER_CHANNEL: "stable"
      AWS_REGION: ap-south-1

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Set up Flutter SDK
        uses: subosito/flutter-action@v2
        with:
          channel: ${{ env.FLUTTER_CHANNEL }}

      - name: Flutter pub get
        run: flutter pub get

      - name: Build single ABI arm64 release APK (unsigned)
        run: |
          flutter clean
          flutter build apk --release --target-platform android-arm64 --split-per-abi
          ls -la build/app/outputs/flutter-apk/

      # Configure AWS credentials for the job
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      # Install awscli via pip (available on the runner)
      - name: Install AWS CLI (via pip)
        run: |
          sudo apt-get update
          sudo apt-get install -y python3-pip
          python3 -m pip install --upgrade pip
          python3 -m pip install --upgrade awscli
          aws --version

      # -----------------------------
      # Create release bundle + upload
      # -----------------------------
      # Requires repo secrets:
      #   AWS_S3_BUCKET = elevate-applications
      # Optional:
      #   ENABLE_PRESIGN = "true"   # to add apkPresignedUrl (24h)
      - name: Create release bundle and upload bundle + latest manifest
        env:
          BUCKET: ${{ secrets.AWS_S3_BUCKET }}
          ENABLE_PRESIGN: ${{ secrets.ENABLE_PRESIGN }}
          AWS_REGION: ${{ env.AWS_REGION }}
        run: |
          set -euo pipefail

          APK_SRC="build/app/outputs/flutter-apk/app-arm64-v8a-release.apk"
          if [ ! -f "$APK_SRC" ]; then
            echo "ERROR: APK not found at $APK_SRC"
            ls -la build/app/outputs/flutter-apk || true
            exit 1
          fi

          # Read version from pubspec.yaml (format: version: 1.3.5+42)
          VERSION_LINE=$(grep '^version:' pubspec.yaml | head -n1 || true)
          if [ -z "$VERSION_LINE" ]; then
            echo "ERROR: version not found in pubspec.yaml"
            exit 1
          fi
          VERSION_RAW=$(echo "$VERSION_LINE" | sed 's/^version:[[:space:]]*//')
          VERSION_NAME="${VERSION_RAW%%+*}"
          VERSION_CODE_STR="${VERSION_RAW#*+}"
          if [ "$VERSION_CODE_STR" = "$VERSION_RAW" ]; then
            VERSION_CODE=0
          else
            VERSION_CODE="${VERSION_CODE_STR}"
          fi
          if ! [[ "$VERSION_CODE" =~ ^[0-9]+$ ]]; then
            VERSION_CODE=0
          fi

          TIMESTAMP=$(date +"%Y-%m-%d_%H-%M-%S")
          BUNDLE_NAME="${VERSION_NAME}_${TIMESTAMP}"
          RELEASE_PREFIX="releases/${BUNDLE_NAME}"
          APK_FILENAME="app-arm64-${TIMESTAMP}.apk"
          S3_APK_KEY="${RELEASE_PREFIX}/${APK_FILENAME}"
          S3_APK_URL="https://${BUCKET}.s3.${AWS_REGION}.amazonaws.com/${S3_APK_KEY}"

          # Compute sha256
          SHA256=$(sha256sum "$APK_SRC" | awk '{print $1}')

          # Upload APK into bundle
          echo "Uploading APK to s3://${BUCKET}/${S3_APK_KEY} ..."
          aws s3 cp "$APK_SRC" "s3://${BUCKET}/${S3_APK_KEY}"

          # Optionally generate presigned URL for APK
          APK_PRESIGNED=null
          if [ "${ENABLE_PRESIGN:-}" = "true" ]; then
            APK_PRESIGNED=$(aws s3 presign "s3://${BUCKET}/${S3_APK_KEY}" --expires-in 86400 || echo "")
          fi

          # Build version.json for this bundle
          UPLOADED_AT=$(date --utc +"%Y-%m-%dT%H:%M:%SZ")
          NOTES="Auto-upload from CI on ${TIMESTAMP}"

          # Create version.json
          # ensure apkPresignedUrl is null if not set
          if [ -n "${APK_PRESIGNED:-}" ]; then
            APK_PRESIGNED_JSON="\"${APK_PRESIGNED}\""
          else
            APK_PRESIGNED_JSON="null"
          fi

          cat > version.json <<EOF
  {
    "category": "android",
    "versionCode": ${VERSION_CODE},
    "versionName": "${VERSION_NAME}",
    "apkFilename": "${APK_FILENAME}",
    "apkPath": "${S3_APK_URL}",
    "apkPresignedUrl": ${APK_PRESIGNED_JSON},
    "sha256": "${SHA256}",
    "notes": "${NOTES}",
    "mandatory": false,
    "uploadedAt": "${UPLOADED_AT}"
  }
  EOF
  
  # Upload version.json into bundle folder
  aws s3 cp version.json "s3://${BUCKET}/${RELEASE_PREFIX}/version.json" --content-type "application/json"
  
  # Build latest manifest that points to this bundle
  cat > manifest.json <<EOF
  {
    "bundle": "${RELEASE_PREFIX}",
    "versionName": "${VERSION_NAME}",
    "versionCode": ${VERSION_CODE},
    "uploadedAt": "${UPLOADED_AT}",
    "category": "android"
  }
  EOF
  
  # Upload latest manifest with cache-control to force revalidation
  aws s3 cp manifest.json "s3://${BUCKET}/latest/manifest.json" \
  --content-type "application/json" \
  --cache-control "no-cache, max-age=0, must-revalidate"
  
  echo "Uploaded bundle to s3://${BUCKET}/${RELEASE_PREFIX}/"
  echo "Latest manifest updated at s3://${BUCKET}/latest/manifest.json"

- name: Done
  run: echo "Build + bundle upload finished"
